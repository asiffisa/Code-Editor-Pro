<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #272822;
        }

        .language-selector {
            padding: 12px 16px;
            background: #2B2B2B;
            border-bottom: 1px solid #3D3D3D;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            padding-right: 40px;
            /* Space for the arrow */
            background-color: #3D3D3D;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            /* Position arrow 16px from right */
            color: #FFFFFF;
            border: 1px solid #4D4D4D;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        select:hover {
            background: #454545;
        }

        select:focus {
            border-color: #BB86FC;
        }

        .editor-container {
            height: calc(100vh - 61px);
            width: 100%;
        }

        .CodeMirror {
            height: 100% !important;
            width: 100% !important;
            font-family: 'Source Code Pro', 'Courier New', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }

        .CodeMirror-gutters {
            background: #272822 !important;
            border-right: 1px solid #3D3D3D !important;
        }

        .CodeMirror-linenumber {
            color: #7E7E7E !important;
            padding: 0 8px !important;
        }
    </style>
</head>

<body>
    <div class="language-selector">
        <select id="language-select">
            <option value="javascript">JavaScript</option>
            <option value="typescript">TypeScript</option>
            <option value="python">Python</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="json">JSON</option>
            <option value="markdown">Markdown</option>
            <option value="xml">XML</option>
            <option value="sql">SQL</option>
        </select>
    </div>

    <div class="editor-container">
        <textarea id="code-editor"></textarea>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>

    <script>
        console.log('Initializing Code Editor...');

        // Configuration constants
        const CONFIG = {
            DEBOUNCE_DELAY: 150,        // ms to wait before syncing changes
            EDITOR_HEIGHT_OFFSET: 61,   // Height offset for editor container
            DEFAULT_LANGUAGE: 'javascript',
            DEFAULT_THEME: 'monokai'
        };

        const languageSelect = document.getElementById('language-select');
        const textarea = document.getElementById('code-editor');

        // Language mode mapping for CodeMirror
        const languageModes = {
            'javascript': 'javascript',
            'typescript': 'javascript',
            'python': 'python',
            'html': 'htmlmixed',
            'css': 'css',
            'json': { name: 'javascript', json: true },
            'markdown': 'markdown',
            'xml': 'xml',
            'sql': 'sql'
        };

        // Monokai theme color mapping for syntax highlighting
        // These colors match the Monokai theme in CodeMirror
        // and are used to generate highlighted tokens for the widget
        const themeColors = {
            'keyword': '#F92672',
            'atom': '#AE81FF',
            'number': '#AE81FF',
            'def': '#FD971F',
            'variable': '#F8F8F2',
            'variable-2': '#9EFFFF',
            'variable-3': '#66D9EF',
            'property': '#A6E22E',
            'operator': '#F92672',
            'comment': '#75715E',
            'string': '#E6DB74',
            'string-2': '#E6DB74',
            'meta': '#555555',
            'builtin': '#66D9EF',
            'tag': '#F92672',
            'attribute': '#A6E22E',
            'header': '#AE81FF',
            'quote': '#AE81FF',
            'link': '#AE81FF',
            'qualifier': '#A6E22E',
            'type': '#66D9EF',
            'default': '#F8F8F2'
        };

        // Utility: Debounce function for performance optimization
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Utility: Copy to clipboard with fallback
        function copyToClipboard(text) {
            // Try modern API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text)
                    .then(() => {
                        console.log('Copy successful via navigator.clipboard');
                        parent.postMessage({ pluginMessage: { type: 'COPY_SUCCESS' } }, '*');
                        return true;
                    })
                    .catch(() => fallbackCopy(text));
            }
            return fallbackCopy(text);
        }

        // Fallback copy method using document.execCommand
        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                console.log('Fallback copy', successful ? 'succeeded' : 'failed');
                if (successful) {
                    parent.postMessage({ pluginMessage: { type: 'COPY_SUCCESS' } }, '*');
                }
                return successful;
            } catch (err) {
                console.error('Failed to copy text:', err);
                return false;
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // Initialize CodeMirror
        let editor;
        try {
            editor = CodeMirror.fromTextArea(textarea, {
                mode: CONFIG.DEFAULT_LANGUAGE,
                theme: CONFIG.DEFAULT_THEME,
                lineNumbers: true,
                indentUnit: 2,
                tabSize: 2,
                indentWithTabs: false,
                lineWrapping: true,
                autofocus: true,
                matchBrackets: true,
                autoCloseBrackets: true
            });

            if (!editor) {
                throw new Error('CodeMirror initialization returned null');
            }

            console.log('CodeMirror initialized successfully');
        } catch (error) {
            console.error('CodeMirror initialization failed:', error);
            // Show user-friendly error message
            document.body.innerHTML = `
                <div style="padding: 20px; color: #ff6b6b; font-family: Inter, sans-serif;">
                    <h2>Editor Failed to Load</h2>
                    <p>Please refresh and try again.</p>
                    <p style="font-size: 12px; color: #999;">Error: ${error.message}</p>
                </div>
            `;
        }

        // Get syntax-highlighted code as token array
        function getHighlightedCode(cm) {
            const lineCount = cm.lineCount();
            const lines = [];
            for (let i = 0; i < lineCount; i++) {
                const tokens = cm.getLineTokens(i);
                const lineTokens = tokens.map(token => ({
                    text: token.string,
                    color: themeColors[token.type] || themeColors.default
                }));
                lines.push(lineTokens);
            }
            return lines;
        }

        // Debounced change handler to reduce message frequency
        const debouncedChange = debounce((cm) => {
            const code = cm.getValue();
            const highlightedLines = getHighlightedCode(cm);

            console.log('Editor changed, syncing code:', code.substring(0, 50) + '...');
            parent.postMessage({
                pluginMessage: {
                    type: 'UPDATE_CODE',
                    code,
                    highlightedLines
                }
            }, '*');
        }, CONFIG.DEBOUNCE_DELAY);

        // Handle editor changes - sync to widget
        if (editor) {
            editor.on('change', debouncedChange);
        }

        // Handle language changes
        if (languageSelect && editor) {
            languageSelect.addEventListener('change', (e) => {
                try {
                    const language = e.target.value;
                    const mode = languageModes[language];

                    if (!mode) {
                        console.warn(`Unknown language: ${language}, falling back to ${CONFIG.DEFAULT_LANGUAGE}`);
                        editor.setOption('mode', CONFIG.DEFAULT_LANGUAGE);
                    } else {
                        editor.setOption('mode', mode);
                    }

                    console.log('Language changed to:', language);

                    // Get updated highlights immediately
                    const highlightedLines = getHighlightedCode(editor);

                    parent.postMessage({
                        pluginMessage: {
                            type: 'UPDATE_LANGUAGE',
                            language,
                            highlightedLines
                        }
                    }, '*');
                } catch (error) {
                    console.error('Error changing language:', error);
                }
            });
        }

        // Handle messages from widget
        window.onmessage = (event) => {
            try {
                if (!event || !event.data || !event.data.pluginMessage) {
                    console.warn('Invalid message received:', event);
                    return;
                }

                const { type, payload } = event.data.pluginMessage;

                if (!type) {
                    console.warn('Message missing type:', event.data);
                    return;
                }

                console.log('Received message:', type, payload);

                if (type === 'INIT') {
                    if (!editor) {
                        console.error('INIT: Editor not initialized');
                        return;
                    }

                    console.log('INIT message:', payload);

                    if (payload.code !== undefined) {
                        editor.setValue(payload.code);
                    }

                    if (payload.language) {
                        languageSelect.value = payload.language;
                        const mode = languageModes[payload.language] || CONFIG.DEFAULT_LANGUAGE;
                        editor.setOption('mode', mode);
                    }
                } else if (type === 'COPY') {
                    if (!payload || !payload.text) {
                        console.error('COPY: Missing text in payload');
                        return;
                    }
                    copyToClipboard(payload.text);
                }
            } catch (error) {
                console.error('Error handling message:', error);
            }
        };

        console.log('Code Editor ready');
    </script>
</body>

</html>